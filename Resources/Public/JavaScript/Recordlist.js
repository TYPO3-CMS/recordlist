/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import Icons from"TYPO3/CMS/Backend/Icons.js";import PersistentStorage from"TYPO3/CMS/Backend/Storage/Persistent.js";import RegularEvent from"TYPO3/CMS/Core/Event/RegularEvent.js";import Tooltip from"TYPO3/CMS/Backend/Tooltip.js";import DocumentService from"TYPO3/CMS/Core/DocumentService.js";import Modal from"TYPO3/CMS/Backend/Modal.js";import{SeverityEnum}from"TYPO3/CMS/Backend/Enum/Severity.js";import Severity from"TYPO3/CMS/Backend/Severity.js";class Recordlist{constructor(){this.identifier={entity:".t3js-entity",toggle:".t3js-toggle-recordlist",localize:".t3js-action-localize",searchboxToolbar:"#db_list-searchbox-toolbar",searchboxToggle:".t3js-toggle-search-toolbox",searchField:"#search_field",icons:{collapse:"actions-view-list-collapse",expand:"actions-view-list-expand",editMultiple:".t3js-record-edit-multiple"}},this.toggleClick=t=>{t.preventDefault();const e=$(t.currentTarget),i=e.data("table"),o=$(e.data("bs-target")),a="expanded"===o.data("state"),n=e.find(".collapseIcon"),l=a?this.identifier.icons.expand:this.identifier.icons.collapse;Icons.getIcon(l,Icons.sizes.small).then(t=>{n.html(t)});let r={};PersistentStorage.isset("moduleData.list")&&(r=PersistentStorage.get("moduleData.list"));const s={};s[i]=a?1:0,$.extend(r,s),PersistentStorage.set("moduleData.list",r).done(()=>{o.data("state",a?"collapsed":"expanded")})},this.onEditMultiple=t=>{t.preventDefault();let e="",i="",o="",a=[];if("multiRecordSelection:action:edit"===t.type){const o=t.detail,n=o.configuration;if(i=n.returnUrl||"",e=n.tableName||"",""===e)return;o.checkboxes.forEach(t=>{const e=t.closest("tr");null!==e&&e.dataset[n.idField]&&a.push(e.dataset[n.idField])})}else{const n=t.currentTarget,l=n.closest("[data-table]");if(null===l)return;if(e=l.dataset.table||"",""===e)return;i=n.dataset.returnUrl||"",o=n.dataset.columnsOnly||"";const r=l.querySelectorAll(this.identifier.entity+'[data-uid][data-table="'+e+'"] td.col-selector input[type="checkbox"]:checked');if(r.length)r.forEach(t=>{a.push(t.closest(this.identifier.entity+'[data-uid][data-table="'+e+'"]').dataset.uid)});else{const t=l.querySelectorAll(this.identifier.entity+'[data-uid][data-table="'+e+'"]');if(!t.length)return;t.forEach(t=>{a.push(t.dataset.uid)})}}if(!a.length)return;let n=top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+e+"]["+a.join(",")+"]=edit&returnUrl="+Recordlist.getReturnUrl(i);""!==o&&(n+="&columnsOnly="+o),window.location.href=n},this.disableButton=t=>{$(t.currentTarget).prop("disable",!0).addClass("disabled")},this.toggleSearchbox=()=>{const t=$(this.identifier.searchboxToolbar);t.toggle(),t.is(":visible")&&$(this.identifier.searchField).focus()},this.deleteRow=t=>{const e=$(`table[data-table="${t.table}"]`),i=e.find(`tr[data-uid="${t.uid}"]`),o=e.closest(".panel"),a=o.find(".panel-heading"),n=e.find(`[data-l10nparent="${t.uid}"]`),l=$().add(i).add(n);if(l.fadeTo("slow",.4,()=>{l.slideUp("slow",()=>{l.remove(),0===e.find("tbody tr").length&&o.slideUp("slow")})}),"0"===i.data("l10nparent")||""===i.data("l10nparent")){const t=Number(a.find(".t3js-table-total-items").html());a.find(".t3js-table-total-items").text(t-1)}"pages"===t.table&&top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))},this.registerPaginationEvents=()=>{document.querySelectorAll(".t3js-recordlist-paging").forEach(t=>{t.addEventListener("keyup",e=>{e.preventDefault();let i=parseInt(t.value,10);i<parseInt(t.min,10)&&(i=parseInt(t.min,10)),i>parseInt(t.max,10)&&(i=parseInt(t.max,10)),"Enter"===e.key&&i!==parseInt(t.dataset.currentpage,10)&&(window.location.href=t.dataset.currenturl+i.toString())})})},$(document).on("click",this.identifier.toggle,this.toggleClick),$(document).on("click",this.identifier.icons.editMultiple,this.onEditMultiple),$(document).on("click",this.identifier.localize,this.disableButton),$(document).on("click",this.identifier.searchboxToggle,this.toggleSearchbox),DocumentService.ready().then(()=>{Tooltip.initialize(".table-fit a[title]"),this.registerPaginationEvents()}),new RegularEvent("typo3:datahandler:process",this.handleDataHandlerResult.bind(this)).bindTo(document),new RegularEvent("multiRecordSelection:action:edit",this.onEditMultiple).bindTo(document),new RegularEvent("multiRecordSelection:action:delete",this.deleteMultiple).bindTo(document),new RegularEvent("multiRecordSelection:action:copyMarked",t=>{Recordlist.submitClipboardFormWithCommand("copyMarked",t.target)}).bindTo(document),new RegularEvent("multiRecordSelection:action:removeMarked",t=>{Recordlist.submitClipboardFormWithCommand("removeMarked",t.target)}).bindTo(document)}static submitClipboardFormWithCommand(t,e){const i=e.closest("form");if(!i)return;const o=i.querySelector('input[name="cmd"]');o&&(o.value=t,i.submit())}static getReturnUrl(t){return""===t&&(t=top.list_frame.document.location.pathname+top.list_frame.document.location.search),encodeURIComponent(t)}handleDataHandlerResult(t){const e=t.detail.payload;e.hasErrors||"datahandler"!==e.component&&"delete"===e.action&&this.deleteRow(e)}deleteMultiple(t){t.preventDefault();const e=t.detail.configuration;Modal.advanced({title:e.title||"Delete",content:e.content||"Are you sure you want to delete those records?",severity:SeverityEnum.warning,buttons:[{text:TYPO3.lang["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:()=>Modal.currentModal.trigger("modal-dismiss")},{text:e.ok||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+Severity.getCssClass(SeverityEnum.warning),trigger:()=>{Modal.currentModal.trigger("modal-dismiss"),Recordlist.submitClipboardFormWithCommand("delete",t.target)}}]})}}export default new Recordlist;